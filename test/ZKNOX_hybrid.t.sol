// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import {Test, console} from "forge-std/Test.sol";
import {ZKNOX_HybridVerifier} from "../src/ZKNOX_hybrid.sol";
import {Signature} from "../src/ZKNOX_dilithium_utils.sol";

contract TestHybridVerifier is Test {
    function testHybridVerify() public {
        if (block.chainid != 421614) {
            return; // silently skip
        }
        // Address of a contract storing a public key
        address hpkAddr = 0x6F6739B758e447F541D7F3c069289864568c702E;
        // NIST MLDSA contract address
        address verifierAddr = 0x86f94e417CB8Df20ba29Bd1c0ca04cFDd4442a96;
        // Deploy hybrid
        ZKNOX_HybridVerifier hybrid = new ZKNOX_HybridVerifier();

        // Initialize the hybrid contract with addresses
        hybrid.initialize(
            hpkAddr, // Public Key Contract address
            verifierAddr, // PQ verification logic
            1 // algoID = 1 for Dilithium
        );

        // Signature
        bytes memory c_tilde = hex"d9591e70b95a0dd2d43abb953b16c7f3aa637d1541e257e6987372b51dbd704d";
        bytes memory z_bytes =
            hex"5a9e22c9f8fc00ca6952100c327b73d12c3c1c61e7a8ed1a53233aeb4e1b669c68c5eaac2e7ccf86ac0caeba6ac4d0d552c34082486dc53436bc79525c43863283bcd5ea524bb6f34f3eb52c89ea86cc5c7039ad2d5c17813286471507fc083ea9c16d1783c416757c050dbabccd92ad3d0bbf4d2b1ab8ca0794b3ffafb6f47fafbd823bec093c2fcf89a1462f26324edc82daf50616116801d25b1923d22dae8f9a9dca0668821f222fb183d4885887a858c15b0024f1c8a5bbaeb4e1d5790b42d5bc789d264068332daef3f1a1fc0e62473d5e73c0d38b7b6d290ecb6217a08a913a0f4634ce9fdab8267e86a0ab50641018eacbe700c2e51d7fa92efd384b21b430e2920e0102960b719c5a51e1b7e1be8bc1e2be25e8a5e859e5f85f484a7c57473a454037d2273cc824d62e60ccd5f105a5327a40ccb73541f43c20408ca21a6f3d24a39b31d02cc2216ca0dd8de26fba84bf6fdb99f703f1d0a90b4e50cde3f8cc2d4fe17becbb17605b19fc6c94a13e43c5af5243f36743aa7c450f4f478d2ed00e86f04b3870ff7cb568b96d55f84d72f638005e68f8563e49541d647d7d427a7a755a004f4547943e9050a932a1fd08aead5a11ac8bebfe3079ef0a051eedf718432a681a53b0341b005e1eab796cb90411eaba8cba14d53a1296cf02446b3de266cdd09717142e1f327b1456eaa5b55367c78baede30fb6e2101dd3714662572ad85026e1b97d0cd3637cc57260239da6423249d99df18741af9483f613b71ddc4bdd1d909a5d10c209ca2673623d6b9a19868e596aadea319de4a4cd3f38e48f50c03bdd107e80b52170d915491aa7a8cbf94578124ee38220cafd58e52a50edb8a6f5b05061512bfae942c97fc9f52d5dd169c732b7cd92e5798202fdbbff1974c7bb4e7ef256ab4816c83eb9c6326d3cbe4d45a45cb1f66013bd83139c699598f9591b14241893827f121dc0e5eee7004c81a62d3de1a6f27a3880529574c46428a06f98808bd6a0885c66a14532e549d53136cb78e311c600e4d5022311c1d3a93543d258dc4d88d52c0359e5d3abd31b649ca55ede6f1c398913fffcf527a3bbbc6d550c8fcd21acd18d20c626515c3d6bc4487b0d7df723f9391f71909fd326b663019c08f77ec257f75fe2a9339264cce48e6c6f32beea35ad7f0a6dbdbca00635024f460bb36d0873ee8e9f362e80f99a825a126082f2761e0f46f4f8257a1ba60c3ef7aea4b1a1abbbed190bf932cee007e73133c3580a4b1559ea0b3b0024505a4108f020c67e2ed573afd72a95a64ab417aa546414a830fc3f08e9dd4ccad52e9309f027aa279fda7f57a8fe75151c650ec4ad443998df83da7d1b9e6e4d5a0f707c73e59325fbe8923968f48385006e2659952a6d6782a76886f6baf3fbfc4244105a0adce945cb0a2c72cb45f5f0b7fb3126c855be752c97575511e109296d8ce5959b1786dfba82e13c031816686b62e5fb3fbb923a8d0c58e26dde2ef8a074dcc2fd4da0d98b2a18b1ce86f02226404cf86dedf9fcd77ac128095b4a96d3e65dd0d7f9c129237a653b3b8a5bf688847b89482ea7f42a855f56167aba16eeeafdd216a880660239b8ce0ff58f7895f48d0d7615d11c4b970dd4cbc7f723ab437cce8066da56bf8cac2442adc25b57467e7d4d5147ba574603c914d077ac9acdd95665b810ef70ca397116ee2c083a109568c534f5e7808011cb2cdeee406b8bfebc934f964e8bef436a96af2e8cf80fe2e3b1d8c90e7f6ecd9fd6aca6c0b2f623b3ee1a51d1f9bc9f8987f4f43d0bd72be960683a8b1583be5dce81e0ca020454f06833ada171c03c4a4a03e232c34043d359169ad726c52643776ab37634c658cffdc10e21622d6f266c3f711f86354f443fe9b81af2cfbde5cbfe4ce204eb5ca97bcab66069d82449ce8fd86ed3815a5fa25b7b01a6555c1ceee367e594a5bed16260e8e697413a6ad2b28703debfd06d1fefecc192a26b99905b15b4da2e76a87c2c9b732fd9c0d37bc8a08a78013d6f8aaf03becc354e14c79e8cdae6a52df01476cad0cd22445cdc31549298855aeb94e04ef151864d88271da49226a7b1553960e33d7d940cd7cbd88804a54ec9fea10825fd885a9753201632f7bd96b8f93736dcd07626aee648eff6c55df6def3f61d804b7f04c64c0ed7f8ff012c895965cfb4c55e5911ac95fa96f3d2fda474b5a1e900193367164e48aa27bd3ad2b1fcc23512d3110580fe7f5be98f24989d5e372662b463fdbc6df0972bf4a4f99a976b47f48b4701029557c5b9d4aff15a8913101d28efb71badb37d2f9ad72523ecc9b4c8177679ff02f19ee41a3fe2347870cbbf969319f04c7210845fa8a0b4fa7f28686878444f703d7da4f2bee57dec1b09bd53d911fe9f0510752b8efd44ca595094f9b0246c16b7956315f126aafde21e0930772a0e88aa5be86c83110cdc7c9c3ab72b049334d675e2a6562c421a839fd48c8de4a3c67245819133c27ad3fd577be5c0fbb2d09eca8ccb7cfd9760f4d79bada370772cd753f47dfc4dc7c2efe9e5391818ab4e046217a0606e3433947fbf94e9ac620d24f52ff1b908d2ba9fdf0fdc4b8f1e314c3d76cb62062212d3757599105589bbf3660d17ec9399f140c5dc529c5e80dfe9bfe773cd17a81e8bf2048c8c956a56e429c97b81cdca6ba53e2867b1638024d11533599022f627eda7250b3bad2e4f6e8cd237edfb185a9094904d01ca93fdb2bd3541fa374af5f1b6fd4bcc38227c1ec3cd929dce785dcf02c96f2d11e328da29fa6aee54a72f479def6d97f3f7652950c6c1fb24875cd96d66e525cfab235a2727301b540322eb10efa8ed7d62aada417e636d105e80c9bc58faea5afbe14de9236d60173d5910a19763df8ecd6acc5fbf3120c91843cf36a2a5e51311f96df1b3760316ac7e163df9d91c216a3cf76a786284031610bdd8ebb626727037e9da22865e3a24c89fdd3854c0adf219c976d20b7d9c925dfa97338c2eefdfdd6969d59485c04168711e00952ce5fdef3b29c63fe109fc516018ca7aeb62a9de9add1f0d0af19b9469d420e901ddddf0b2b5825c0b7c4a76d45f17081597a86c5d4183299a0af977a31ef11acc9ba488c7f59f7212b4dac48d9b7b65beee404ed98bb0a7018cb2254f5bb25b77efaefe1041f4701aa91187ba85bc5b25ec3b7ac615330e2cad3979f4a7185b29aa15caf0590f95ec5784de74e33d0450833870a0b0cd9a24171444186";
        bytes memory h_bytes =
            hex"00222d2f3e485a656c8588949cc7c8d00f17292c3243475b71909799c3d3d5d8de245b6d888e9cbcc5e7e8ebf7081236464763666f707997c1d2d5f6000000000000000000000000000000000000000010212d3c";
        Signature memory sig;
        sig.c_tilde = c_tilde;
        sig.z = z_bytes;
        sig.h = h_bytes;

        // MESSAGE
        bytes memory data = hex"1111222233334444111122223333444411112222333344441111222233334444";

        bytes32 r = hex"1c12a44a9c03d96c25b58ef87b3a728e2b348743ea25d00762d8a26be5e12e20";
        bytes32 s = hex"46f984f5f56e563b2e5b415d0697b5ca0151163134ecf059593972c9254e76f4";

        // Now call hybrid verification
        bool valid = hybrid.isValid(data, sig, 28, r, s);

        assertTrue(valid);
    }
}
