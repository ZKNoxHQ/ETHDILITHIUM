import { ethers } from 'ethers';
import { ml_dsa44 } from '@noble/post-quantum/ml-dsa.js';
import { decodePublicKey, recoverAhat, compact_module_256 } from './utils_mldsa.js';
import { deployPublicKey, preparePublicKeyForDeployment } from './pkDeploy.js';
import { deployERC4337Account } from './accountDeploy.js';

function hexToU8(hex) {
  if (hex.startsWith("0x")) hex = hex.slice(2);
  if (hex.length !== 64) {
    throw new Error("Seed must be 32 bytes (64 hex chars)");
  }
  return Uint8Array.from(
    hex.match(/.{2}/g).map(b => parseInt(b, 16))
  );
}

const CONTRACT_BYTECODE = "0x61010060405234610080576107b68038038061001a81610098565b928339810190602081830312610080578051916001600160401b0383116100805761004e9261004992016100c2565b61015f565b6040516105669081610250823960805181606e015260a0518161010e015260c0518161014b015260e051816101710152f35b5f80fd5b634e487b7160e01b5f52604160045260245ffd5b6040519190601f01601f191682016001600160401b038111838210176100bd57604052565b610084565b81601f82011215610080578051906001600160401b0382116100bd576100f1601f8301601f1916602001610098565b928284526020838301011161008057815f9260208093018386015e8301015290565b1561011a57565b60405162461bcd60e51b815260206004820152601360248201527f7472206d757374206265203634206279746573000000000000000000000000006044820152606490fd5b80518101606082602083019203126100805760208201516001600160401b03811161008057816020610193928501016100c2565b60408301516001600160401b038111610080578260206101b5928601016100c2565b60608401519093906001600160401b038111610080576101fb9360206101e0926101f39401016100c2565b916101ee6040865114610113565b610211565b608052610211565b60a052604060208201519101519060c05260e052565b9081518060401b6bfe61000180600a3d393df3000161fffe8211840152600b8101601584015ff09283156102425752565b63301164255f526004601cfdfe60806040526004361015610011575f80fd5b5f3560e01c632e33445214610024575f80fd5b346101ea575f7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126101ea576060604061005e610382565b82815282602082015201526100927f00000000000000000000000000000000000000000000000000000000000000006104e7565b80518101906020818184019303126101ea5760208101519067ffffffffffffffff82116101ea570181603f820112156101ea5760208101516100db6100d6826103cd565b6103a7565b916020808085858152019360051b83010101918483116101ea5760408201905b8382106101ba576101b6856101416101327f00000000000000000000000000000000000000000000000000000000000000006104e7565b602080825183010191016104a4565b6101496104ca565b7f000000000000000000000000000000000000000000000000000000000000000060208201527f0000000000000000000000000000000000000000000000000000000000000000604082015261019d610382565b928352602083015260408201526040519182918261029a565b0390f35b815167ffffffffffffffff81116101ea576020916101df8884808095890101016103e5565b8152019101906100fb565b5f80fd5b9080602083519182815201906020808260051b8501019401915f905b82821061021957505050505090565b909192939594601f19878203018252845190602080835192838152019201905f905b80821061025d575050506020806001929601920192019092919593949561020a565b9091926020806001928651815201940192019061023b565b90601f19601f602080948051918291828752018686015e5f8582860101520116010190565b919060208352608083019281519360606020830152845180915260a0820190602060a08260051b8501019601915f905b82821061030c575050505060406102f461030994956020850151601f198583030184860152610275565b920151906060601f19828503019101526101ee565b90565b90919296602080610347837fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6089600196030186528b516101ee565b9901920192019092916102ca565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b604051906060820182811067ffffffffffffffff8211176103a257604052565b610355565b90601f19601f604051930116820182811067ffffffffffffffff8211176103a257604052565b67ffffffffffffffff81116103a25760051b60200190565b9080601f830112156101ea578151906104006100d6836103cd565b9260208085858152019360051b820101908282116101ea5760208101935b82851061042d57505050505090565b845167ffffffffffffffff81116101ea57820184603f820112156101ea5760208101519061045d6100d6836103cd565b916020808085848152019260051b84010101918783116101ea57604001905b8282106104945750505081526020948501940161041e565b815181526020918201910161047c565b906020828203126101ea57815167ffffffffffffffff81116101ea5761030992016103e5565b6060906104d6826103a7565b6040815291601f1901366020840137565b9060408051837fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82953b0164ffffffffff16905f6021830191601f8501903c808252010160405256fea26469706673582212208de3bd6548579e4c1c0a452b73b220a7b2fa8942b7a2d062e307fedc77946afc64736f6c634300081e0033";

async function main() {
    const privateKey = process.argv[2];
    const providerUrl = "https://eth-sepolia-testnet.api.pocket.network";
    const factoryAddress = "0xeF20058f1b1D56dFe950bB42293111671888b54a";
    
    // seeds
    const prequantum_seed = "0xcafecafecafecafecafecafecafecafecafecafecafecafecafecafecafecafe";
    const postquantum_seed = "0xdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeef";
    
    // prequantum pubkey
    const preQuantumPubKey = new ethers.Wallet(prequantum_seed).address;
    
    // postquantum pubkey
    const { publicKey, _ } = ml_dsa44.keygen(hexToU8(postquantum_seed));
    const { rho, t1, tr } = decodePublicKey(publicKey);
    const trHex = "0x" + Buffer.from(tr).toString("hex");
    
    const A_hat = recoverAhat(rho, 4, 4);
    const A_hat_compact = compact_module_256(A_hat, 32);
    const t1_compact_raw = compact_module_256([t1], 32);  // This gives [1][4][32]
    const t1_compact = t1_compact_raw[0];  // Flatten to [4][32]

    console.log("üîç Structure check:");
    console.log("A_hat_compact dimensions:", A_hat_compact.length, "√ó", A_hat_compact[0]?.length, "√ó", A_hat_compact[0]?.[0]?.length);
    console.log("t1_compact dimensions:", t1_compact.length, "√ó", t1_compact[0]?.length);

    console.log("\nüöÄ Starting full deployment process...");

    // Step 1: Prepare public key data
    console.log("\nStep 1: Encoding public key data...");
    const publicKeyData = preparePublicKeyForDeployment(A_hat_compact, trHex, t1_compact);

    // Step 2: Deploy PKContract
    console.log("\nStep 2: Deploying PKContract...");
    const pkResult = await deployPublicKey(
        publicKeyData,
        CONTRACT_BYTECODE,
        providerUrl,
        privateKey
    );
    
    if (!pkResult.success) {
        console.error("‚ùå PKContract deployment failed. Aborting.");
        process.exit(1);
    }
    
    console.log("\n‚úÖ PKContract deployed at:", pkResult.address);
    
    // Step 3: Deploy ERC4337 Account
    console.log("\n" + "=".repeat(60));
    console.log("Step 3: Deploying ERC4337 Account...");
    const accountResult = await deployERC4337Account(
        factoryAddress,
        preQuantumPubKey,
        pkResult.address,
        providerUrl,
        privateKey
    );
    
    if (accountResult.success) {
        console.log("\n" + "=".repeat(60));
        console.log("üéâ FULL DEPLOYMENT COMPLETE!");
        console.log("=".repeat(60));
        console.log("üìç PKContract:", pkResult.address);
        console.log("üìç ERC4337 Account:", accountResult.address);
        console.log("=".repeat(60));
    } else {
        console.error("‚ùå Account deployment failed");
        process.exit(1);
    }
}

main().catch(console.error);