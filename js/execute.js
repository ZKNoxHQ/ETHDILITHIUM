import { ethers } from 'ethers';
import { ml_dsa44 } from '@noble/post-quantum/ml-dsa.js';
import { decodePublicKey, recoverAhat, compact_module_256 } from './utils_mldsa.js';
import { deployPublicKey } from './pkDeploy.js';
import { deployERC4337Account } from './accountDeploy.js';

function hexToU8(hex) {
  if (hex.startsWith("0x")) hex = hex.slice(2);
  if (hex.length !== 64) {
    throw new Error("Seed must be 32 bytes (64 hex chars)");
  }
  return Uint8Array.from(
    hex.match(/.{2}/g).map(b => parseInt(b, 16))
  );
}

// This code is obtained from the bytecode of src/ZKNOX_PKContract.sol built into `out/`.
const CONTRACT_BYTECODE = "0x610100604052348015610010575f5ffd5b50604051610b90380380610b9083398101604081905261002f916102f1565b81516040146100845760405162461bcd60e51b815260206004820152601360248201527f7472206d75737420626520363420627974657300000000000000000000000000604482015260640160405180910390fd5b6100ad836040516020016100989190610478565b60408051601f198184030181529190526100f5565b6001600160a01b03166080526040516100ce906100989083906020016104db565b6001600160a01b031660a05250602081015160409091015160c09190915260e052506104f4565b5f81518060401b6bfe61000180600a3d393df3000161fffe8211840152600b8101601584015ff09150816101305763301164255f526004601cfd5b90915290565b634e487b7160e01b5f52604160045260245ffd5b604051601f8201601f191681016001600160401b038111828210171561017257610172610136565b604052919050565b5f6001600160401b0382111561019257610192610136565b5060051b60200190565b5f82601f8301126101ab575f5ffd5b81516101be6101b98261017a565b61014a565b8082825260208201915060208360051b8601019250858311156101df575f5ffd5b602085015b8381101561027c5780516001600160401b03811115610201575f5ffd5b8601603f81018813610211575f5ffd5b60208101516102226101b98261017a565b808282526020820191506020808460051b8601010192508a831115610245575f5ffd5b6040840193505b8284101561026757835182526020938401939091019061024c565b865250506020938401939190910190506101e4565b5095945050505050565b5f82601f830112610295575f5ffd5b81516001600160401b038111156102ae576102ae610136565b6102c1601f8201601f191660200161014a565b8181528460208386010111156102d5575f5ffd5b8160208501602083015e5f918101602001919091529392505050565b5f5f5f60608486031215610303575f5ffd5b83516001600160401b03811115610318575f5ffd5b8401601f81018613610328575f5ffd5b80516103366101b98261017a565b8082825260208201915060208360051b850101925088831115610357575f5ffd5b602084015b838110156103975780516001600160401b03811115610379575f5ffd5b6103888b60208389010161019c565b8452506020928301920161035c565b506020880151909650925050506001600160401b038111156103b7575f5ffd5b6103c386828701610286565b604086015190935090506001600160401b038111156103e0575f5ffd5b6103ec8682870161019c565b9150509250925092565b5f82825180855260208501945060208160051b830101602085015f5b8381101561046c57848303601f19018852815180518085526020918201918501905f5b81811015610453578351835260209384019390920191600101610435565b50506020998a0199909450929092019150600101610412565b50909695505050505050565b5f602082016020835280845180835260408501915060408160051b8601019250602086015f5b828110156104cf57603f198786030184526104ba8583516103f6565b9450602093840193919091019060010161049e565b50929695505050505050565b602081525f6104ed60208301846103f6565b9392505050565b60805160a05160c05160e05161066b6105255f395f61013d01525f61011301525f60b801525f6075015261066b5ff3fe608060405234801561000f575f5ffd5b5060043610610029575f3560e01c80632e3344521461002d575b5f5ffd5b61003561004b565b60405161004291906102be565b60405180910390f35b61006f60405180606001604052806060815260200160608152602001606081525090565b5f6100997f0000000000000000000000000000000000000000000000000000000000000000610187565b90505f818060200190518101906100b0919061054a565b90505f6100dc7f0000000000000000000000000000000000000000000000000000000000000000610187565b90505f818060200190518101906100f391906105fb565b604080518181526060810182529192505f919060208201818036833750507f00000000000000000000000000000000000000000000000000000000000000006020838101919091527f00000000000000000000000000000000000000000000000000000000000000006040808501919091528051606081018252978852908701929092525084019190915250909392505050565b60405164ffffffffff7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff833b0116602181015f601f8401853c80825260408201810160405250919050565b5f82825180855260208501945060208160051b830101602085015f5b83811015610266578483037fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0018852815180518085526020918201918501905f5b8181101561024d57835183526020938401939092019160010161022f565b50506020998a01999094509290920191506001016101ee565b50909695505050505050565b5f81518084528060208401602086015e5f6020828601015260207fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f83011685010191505092915050565b602081525f6080820183516060602085015281815180845260a08601915060a08160051b87010193506020830192505f5b8181101561033e577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff608786030183526103298585516101d2565b945060209384019392909201916001016102ef565b5050505060208401517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe084830301604085015261037b8282610272565b91505060408401517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08483030160608501526103b782826101d2565b95945050505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b604051601f82017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe016810167ffffffffffffffff81118282101715610434576104346103c0565b604052919050565b5f67ffffffffffffffff821115610455576104556103c0565b5060051b60200190565b5f82601f83011261046e575f5ffd5b815161048161047c8261043c565b6103ed565b8082825260208201915060208360051b8601019250858311156104a2575f5ffd5b602085015b8381101561054057805167ffffffffffffffff8111156104c5575f5ffd5b8601603f810188136104d5575f5ffd5b60208101516104e661047c8261043c565b808282526020820191506020808460051b8601010192508a831115610509575f5ffd5b6040840193505b8284101561052b578351825260209384019390910190610510565b865250506020938401939190910190506104a7565b5095945050505050565b5f6020828403121561055a575f5ffd5b815167ffffffffffffffff811115610570575f5ffd5b8201601f81018413610580575f5ffd5b805161058e61047c8261043c565b8082825260208201915060208360051b8501019250868311156105af575f5ffd5b602084015b838110156105f057805167ffffffffffffffff8111156105d2575f5ffd5b6105e18960208389010161045f565b845250602092830192016105b4565b509695505050505050565b5f6020828403121561060b575f5ffd5b815167ffffffffffffffff811115610621575f5ffd5b61062d8482850161045f565b94935050505056fea26469706673582212204c982bfbdcddea16be0631cd7d77e1c2eb9ef01cb5d37427c573aebd9c5fe11764736f6c634300081e0033";


async function main() {
    const privateKey = process.argv[2];
    const providerUrl = "https://eth-sepolia-testnet.api.pocket.network";
    const factoryAddress = "0xeF20058f1b1D56dFe950bB42293111671888b54a"; // adddress on sepolia
    // seeds
    const prequantum_seed = "0xcafecafecafecafecafecafecafecafecafecafecafecafecafecafecafecafe";
    const postquantum_seed = "0xdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeef";
    // prequantum pubkey
    const preQuantumPubKey = new ethers.Wallet(prequantum_seed).address;
    // postquantum pubkey
    const { publicKey, _ } = ml_dsa44.keygen(hexToU8(postquantum_seed));
    const { rho, t1, tr } = decodePublicKey(publicKey);
    const trHex = "0x" + Buffer.from(tr).toString("hex");
    
    const A_hat = recoverAhat(rho, 4, 4);
    const A_hat_compact = compact_module_256(A_hat, 32);
    const t1_compact = compact_module_256([t1], 32);  
    
    console.log("üöÄ Starting full deployment process...\n");
    
    // Step 1: Deploy PKContract
    console.log("Step 1: Deploying PKContract...");
    const pkResult = await deployPublicKey(
        A_hat_compact,
        trHex,
        t1_compact,
        CONTRACT_BYTECODE,
        providerUrl,
        privateKey
    );
    
    if (!pkResult.success) {
        console.error("‚ùå PKContract deployment failed. Aborting.");
        process.exit(1);
    }
    
    console.log("\n‚úÖ PKContract deployed at:", pkResult.address);
    
    // Step 2: Deploy ERC4337 Account using the PKContract address
    console.log("\n" + "=".repeat(60));
    console.log("Step 2: Deploying ERC4337 Account...");
    const accountResult = await deployERC4337Account(
        factoryAddress,
        preQuantumPubKey,
        pkResult.address, // Use the deployed PK contract address
        providerUrl,
        privateKey
    );
    
    if (accountResult.success) {
        console.log("\n" + "=".repeat(60));
        console.log("üéâ FULL DEPLOYMENT COMPLETE!");
        console.log("=".repeat(60));
        console.log("üìç PKContract:", pkResult.address);
        console.log("üìç ERC4337 Account:", accountResult.address);
        console.log("=".repeat(60));
    } else {
        console.error("‚ùå Account deployment failed");
        process.exit(1);
    }
}

main().catch(console.error);
