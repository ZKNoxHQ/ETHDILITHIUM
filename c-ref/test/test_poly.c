#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <assert.h>
#include <stdbool.h>
#include "../keccak_prng.h"
#include "../poly.h"

void test_poly_uniform_eta(void);

void test_poly_uniform_eta()
{
    printf("Test: Poly Uniform Eta\n");

    // a seed made of 0s and one 1 at the end.
    uint8_t seed[] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1};

    // polynomial obtained from python with counter = 1
    int8_t expected_coeffs[] = {0, -2, 0, -2, 1, -2, 1, -2, -2, 2, -2, 2, 1, -1, -2, 0, 0, -1, -2, 2, 2, 2, 0, 2, 2, -1, -1, -1, 2, 1, -2, -2, 2, -2, -2, -1, 2, 0, -1, -1, 0, 0, 1, 0, 1, -2, 1, 0, -1, -2, 0, -2, 0, 2, 0, 2, 1, 0, 1, -1, -2, -1, 1, 1, 2, 2, -2, 2, -1, 2, 2, -1, 2, 1, 1, -2, -1, -2, -1, 0, 1, 0, 1, 2, -1, 0, -1, 0, 1, -2, 0, 1, -2, 1, -2, -1, 2, 2, -2, -2, -1, 1, 0, 1, 0, 0, 2, -2, -1, 0, -1, 2, -1, -2, 1, -1, -2, -1, 1, -1, 0, 0, 2, 1, 2, -2, 1, -2, 2, -2, 2, 2, 0, -2, 0, 2, 0, -2, 2, 1, 1, 1, -2, 1, 2, -1, -2, 1, -1, -1, 1, 0, 2, 1, -1, 0, 2, 1, 1, 2, 0, 2, 0, 0, 1, 1, -2, -2, 0, 2, 0, 1, 2, -1, -1, 2, -2, 0, 1, -1, 2, 1, 2, -1, -1, -2, 2, 2, -1, 0, 1, -2, 2, 2, -2, 1, 0, 1, 1, 0, 2, -1, 0, -1, 2, 0, 2, -1, -2, 0, 0, 1, -2, 2, 0, 2, -2, 2, 1, -2, -2, 1, -1, -2, 2, 1, 2, 2, -2, 2, -1, -2, 2, 1, -2, 2, 2, -2, 1, 2, 1, -2, 1, 2, -1, 1, 1, 1, 2, -1, -2, -1, -1, 0, 0, 2};
    // polynomial obtained from python with counter = 0
    int8_t expected_coeffs_2[] = {1, -1, 2, 2, -2, -2, 0, 0, 1, 2, 2, 1, 1, -2, -2, 2, -2, -2, -2, 0, -1, -2, 0, 0, 2, 1, 2, -2, 0, -1, 1, 2, 0, 2, -1, 2, 0, 0, -2, -1, -1, -1, 2, -1, -2, 2, 1, 0, -2, 2, 1, 0, -1, 0, 1, -1, -2, -2, 0, 2, -1, -2, 1, -1, 0, -2, -2, 2, 2, -2, -2, -1, 0, -2, 2, 2, -2, 1, 1, -2, -2, -1, 1, 0, 1, -2, -1, 0, -2, -2, -1, -2, 1, -2, -1, 0, -2, 1, 0, 2, -1, 2, 1, -1, 2, -1, -1, 2, 2, -2, -2, -2, 2, -2, 0, 2, 1, -2, 1, -1, -2, 1, 1, -1, -1, -2, 1, 0, -1, -1, 2, 0, 0, 0, 1, -1, 1, -1, 1, -1, -2, 1, 1, -2, 2, -1, -2, -1, 2, 2, 2, -1, -1, 0, 0, -2, 1, 1, 0, 2, 1, 1, 0, 2, 2, 2, 1, 2, 2, 2, -2, 1, 2, -2, -1, 0, 0, 1, -1, 1, -2, -2, 0, -2, 1, 2, 0, 0, -2, 2, 1, -2, -1, 1, 2, 0, -1, 0, 1, 0, 2, -2, -2, -2, -2, 0, -1, 1, 1, 0, -1, 0, 1, -2, -1, 0, 0, 1, 2, -2, 1, 1, 2, -1, -2, 1, 0, -1, 0, -2, 1, -2, -2, 2, -2, -2, 1, 0, -1, 1, -1, -2, -1, 1, -1, -1, 2, -2, -2, 1, -2, -2, 1, 0, 2, -2};

    poly p;
    // with counter = 1
    poly_uniform_eta(&p, seed, 1);
    for (int i = 0; i < 256; i++)
    {
        assert(p.coeffs[i] == expected_coeffs[i]);
    }
    // with counter = 0
    poly_uniform_eta(&p, seed, 0);
    for (int i = 0; i < 256; i++)
    {
        assert(p.coeffs[i] == expected_coeffs_2[i]);
    }
    printf("PASSED: poly_uniform_eta outputs the same as python\n");
}

void test_poly_uniform(void);

void test_poly_uniform()
{
    printf("Test: Poly Uniform\n");

    uint8_t seed[] = {0x7A, 0x32, 0x41, 0x57, 0x41, 0xA9, 0x35, 0x7C, 0xDB, 0x07, 0xA5, 0x85, 0x3F, 0x80, 0xD1, 0x8A, 0x7A, 0x2A, 0xAA, 0xBC, 0xDE, 0x44, 0x1B, 0x44, 0xA0, 0x3A, 0x0E, 0x3F, 0x84, 0x4D, 0x4A, 0x19};
    uint16_t val = 0;
    // polynomial obtained from python
    int32_t expected[] = {1356645, 6263334, 7976308, 5545123, 660179, 6981953, 2112361, 1988975, 5008164, 5683379, 4432094, 7958861, 4683253, 6264897, 370886, 7406122, 7843505, 6426748, 3126710, 8332850, 8151280, 3280780, 8042079, 8355590, 4000141, 7336450, 4609536, 3956571, 6293903, 5951462, 1070701, 4963657, 374344, 366827, 7539893, 344279, 7979026, 1044623, 8005679, 5581725, 5023482, 5554123, 1442767, 1956676, 7095408, 7883076, 258429, 6359201, 4615998, 2567585, 633034, 5905695, 3505833, 3672972, 675234, 2847395, 1703853, 3844509, 6978655, 6248742, 1572975, 731859, 6257092, 582333, 6732776, 1841205, 662007, 6832207, 2337923, 6478476, 4135105, 2306050, 1588046, 5364311, 2727889, 390597, 1576827, 7948641, 3651659, 1600549, 5259233, 8300450, 8315627, 6634441, 1906152, 3985925, 1240451, 7740258, 5648545, 733995, 2388704, 6550018, 6683214, 7243316, 4221350, 5777311, 2924121, 7499332, 8176897, 7352832, 4187055, 8053633, 6736039, 5570548, 4333065, 335852, 5363098, 6270062, 5217808, 7102261, 560124, 1249081, 2180503, 2544793, 1643167, 884806, 4385851, 3327330, 8205029, 1087722, 7305877, 4070120, 3112008, 332100, 965556, 3836487, 5887859, 5247918, 3016663, 7833799, 3521585, 6675673, 5505162, 1655429, 3545413, 2937424, 7675370, 4193846, 5337208, 6525596, 5340983, 1145866, 1449684, 4025263, 6312688, 3804611, 4559691, 226267, 3800924, 5436818, 1839954, 8312657, 8281727, 3327075, 3258989, 6923307, 1651349, 6078185, 4606377, 4511633, 320675, 6872307, 1512507, 2388576, 5723188, 5783541, 2996063, 3988209, 5599708, 5257566, 8166681, 3539709, 7703485, 2058375, 6818000, 1172116, 7377503, 1248130, 4163450, 4321179, 899201, 2201168, 1545842, 3591240, 3941782, 727119, 7478519, 1231676, 2153440, 3541036, 7498037, 6810194, 1130489, 7078261, 6365402, 7105946, 43519, 1899699, 1904225, 5856996, 5041771, 5088818, 1908884, 3338420, 450440, 6319197, 2078870, 4967856, 1967414, 6942212, 4051217, 477658, 6240764, 1415387, 1907652, 4403917, 6943500, 6887904, 2946877, 2448761, 7838947, 4677819, 3036908, 3864189, 4597397, 201017, 691958, 7277195, 3011658, 1294012, 5823583, 51933, 2797027, 2367246, 4571476, 4051284, 5196530, 5351703, 7007546, 848142, 3806170, 6632526, 4550606, 7598983, 4353118, 3554696, 6729004, 4436900, 7177714, 3692617, 3441025, 7964091, 765119, 8235287, 608936, 5055175};
    poly p;
    poly_uniform(&p, seed, val);
    for (int i = 0; i < 256; i++)
    {
        assert(p.coeffs[i] == expected[i]);
    }
    printf("PASSED: poly_uniform outputs the same as python\n");
}

int main()
{
    printf("Running Poly Tests\n");
    printf("==========================\n\n");

    test_poly_uniform();
    test_poly_uniform_eta();

    printf("\nAll Poly tests passed successfully!\n");
    return 0;
}